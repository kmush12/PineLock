{% extends "base.html" %}

{% block title %}Panel gÅ‚Ã³wny - PineLock{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <!-- Smaller logo for sidebar -->
            <svg class="sidebar-logo" viewBox="0 0 200 240" xmlns="http://www.w3.org/2000/svg">
                <polygon points="100,30 60,90 75,90" fill="#3a8660"/>
                <polygon points="100,30 140,90 125,90" fill="#4a9670"/>
                <polygon points="100,70 50,140 70,140" fill="#3a8660"/>
                <polygon points="100,70 150,140 130,140" fill="#4a9670"/>
                <polygon points="100,110 40,190 65,190" fill="#3a8660"/>
                <polygon points="100,110 160,190 135,190" fill="#4a9670"/>
                <rect x="85" y="190" width="30" height="50" fill="#3a8660"/>
                <rect x="100" y="190" width="15" height="50" fill="#4a9670"/>
                <circle cx="100" cy="120" r="22" fill="#f5f5dc"/>
                <path d="M 90,130 L 90,160 L 110,160 L 110,130 L 105,130 L 105,145 L 95,145 L 95,130 Z" fill="#f5f5dc"/>
            </svg>
            <h2 class="sidebar-title">PineLock</h2>
            <p class="sidebar-subtitle">System zarzÄ…dzania</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/dashboard" class="nav-item active">
                <span class="nav-icon">ğŸ </span>
                Panel gÅ‚Ã³wny
            </a>
            <a href="/locks" class="nav-item">
                <span class="nav-icon">ğŸ”</span>
                Domki
            </a>
            <a href="/access-codes" class="nav-item">
                <span class="nav-icon">ğŸ”¢</span>
                Kody PIN
            </a>
            <a href="/rfid-cards" class="nav-item">
                <span class="nav-icon">ğŸ“‡</span>
                Karty RFID
            </a>
            <a href="/access-logs" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                Historia dostÄ™pu
            </a>
            <a href="/settings" class="nav-item">
                <span class="nav-icon">âš™ï¸</span>
                Ustawienia
            </a>
            <a href="/logout" class="nav-item" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <span class="nav-icon">ğŸšª</span>
                Wyloguj siÄ™
            </a>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <div class="header">
            <h1 class="header-title">ğŸ  Panel gÅ‚Ã³wny</h1>
            <div class="header-actions">
                <div class="user-info">
                    <div class="user-avatar">{{ user_initial }}</div>
                    <span>{{ username }}</span>
                </div>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon green">
                    ğŸ”
                </div>
                <div class="stat-info">
                    <div class="stat-label">Wszystkie domki</div>
                    <div class="stat-value">{{ total_locks }}</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon green">
                    ğŸ”’
                </div>
                <div class="stat-info">
                    <div class="stat-label">ZamkniÄ™te</div>
                    <div class="stat-value">{{ locked_count }}</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon yellow">
                    ğŸ”“
                </div>
                <div class="stat-info">
                    <div class="stat-label">Otwarte</div>
                    <div class="stat-value">{{ unlocked_count }}</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon red">
                    ğŸ“¡
                </div>
                <div class="stat-info">
                    <div class="stat-label">Offline</div>
                    <div class="stat-value">{{ offline_count }}</div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div style="margin-bottom: 20px; display: flex; gap: 15px;">
            <a href="/locks/new" class="btn btn-primary" style="width: auto;">
                â• Dodaj nowy domek
            </a>
            <button class="btn btn-secondary" onclick="refreshLocks()">
                ğŸ”„ OdÅ›wieÅ¼ status
            </button>
        </div>
        
        <!-- Locks Grid -->
        <div class="locks-grid">
            {% for lock in locks %}
            <div class="lock-card">
                <div class="lock-card-header">
                    <div class="lock-icon {{ 'locked' if lock.is_locked else 'unlocked' }}">
                        {{ 'ğŸ”’' if lock.is_locked else 'ğŸ”“' }}
                    </div>
                    <span class="lock-status-badge {{ 'status-locked' if lock.is_locked else 'status-unlocked' if lock.is_online else 'status-offline' }}">
                        {{ 'ZamkniÄ™ty' if lock.is_locked else 'Otwarty' if lock.is_online else 'Offline' }}
                    </span>
                </div>
                
                <div class="lock-card-body">
                    <h3 class="lock-name">{{ lock.name }}</h3>
                    <p class="lock-location">ğŸ“ {{ lock.location }}</p>
                    <p class="lock-id">ID: {{ lock.device_id }}</p>
                    {% if lock.last_seen %}
                    <p class="lock-id" style="margin-top: 8px;">
                        â° Ostatnio widziany: {{ lock.last_seen }}
                    </p>
                    {% endif %}
                </div>
                
                <div class="lock-card-footer">
                    <a href="/locks/{{ lock.id }}" class="btn btn-secondary btn-sm">
                        ğŸ‘ï¸ SzczegÃ³Å‚y
                    </a>
                    {% if lock.is_online %}
                        {% if lock.is_locked %}
                        <button class="btn btn-success btn-sm" onclick="toggleLock('{{ lock.id }}', 'unlock')">
                            ğŸ”“ OtwÃ³rz
                        </button>
                        {% else %}
                        <button class="btn btn-danger btn-sm" onclick="toggleLock('{{ lock.id }}', 'lock')">
                            ğŸ”’ Zamknij
                        </button>
                        {% endif %}
                    {% else %}
                    <button class="btn btn-sm" style="background: #ccc; cursor: not-allowed;" disabled>
                        âš ï¸ Offline
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if not locks %}
        <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(30, 89, 69, 0.15);">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”</div>
            <h2 style="color: var(--forest-green); margin-bottom: 10px;">Brak domkÃ³w</h2>
            <p style="color: var(--dark-gray); margin-bottom: 30px;">Dodaj pierwszy domek, aby rozpoczÄ…Ä‡ zarzÄ…dzanie</p>
            <a href="/locks/new" class="btn btn-primary" style="width: auto;">
                â• Dodaj domek
            </a>
        </div>
        {% endif %}
        
        <!-- Recent Access Logs -->
        <div style="margin-top: 40px;">
            <h2 style="color: var(--forest-green); font-size: 24px; margin-bottom: 20px;">
                ğŸ“Š Ostatnie zdarzenia
            </h2>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Czas</th>
                            <th>Domek</th>
                            <th>Typ dostÄ™pu</th>
                            <th>Akcja</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in recent_logs %}
                        <tr>
                            <td>{{ log.timestamp }}</td>
                            <td>{{ log.lock_name }}</td>
                            <td>{{ 'ğŸ”¢ PIN' if log.access_type == 'pin' else 'ğŸ“‡ RFID' if log.access_type == 'rfid' else 'ğŸŒ Remote' }}</td>
                            <td>{{ log.action }}</td>
                            <td>
                                {% if log.success %}
                                <span class="text-success">âœ… Sukces</span>
                                {% else %}
                                <span class="text-error">âŒ Odmowa</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% if not recent_logs %}
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--dark-gray);">
                                Brak ostatnich zdarzeÅ„
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: var(--forest-green); font-weight: 600;">
            WysyÅ‚anie komendy...
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function toggleLock(lockId, action) {
        const modal = document.getElementById('loadingModal');
        modal.classList.add('active');
        
        try {
            const response = await fetch(`/api/v1/locks/${lockId}/command`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command: action })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Success - refresh page after short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                alert('âŒ BÅ‚Ä…d: ' + (data.detail || 'Nie udaÅ‚o siÄ™ wykonaÄ‡ operacji'));
                modal.classList.remove('active');
            }
        } catch (error) {
            alert('âŒ BÅ‚Ä…d poÅ‚Ä…czenia: ' + error.message);
            modal.classList.remove('active');
        }
    }
    
    async function refreshLocks() {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'â³ OdÅ›wieÅ¼anie...';
        
        try {
            // Request status update from all locks
            const response = await fetch('/api/v1/locks');
            if (response.ok) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        } catch (error) {
            console.error('Refresh error:', error);
            btn.disabled = false;
            btn.textContent = 'ğŸ”„ OdÅ›wieÅ¼ status';
        }
    }
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        window.location.reload();
    }, 30000);
</script>
{% endblock %}
