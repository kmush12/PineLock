{% extends "base.html" %}

{% block title %}{{ lock.name }} - PineLock{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar (same as dashboard) -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <svg class="sidebar-logo" viewBox="0 0 200 240" xmlns="http://www.w3.org/2000/svg">
                <polygon points="100,30 60,90 75,90" fill="#3a8660"/>
                <polygon points="100,30 140,90 125,90" fill="#4a9670"/>
                <polygon points="100,70 50,140 70,140" fill="#3a8660"/>
                <polygon points="100,70 150,140 130,140" fill="#4a9670"/>
                <polygon points="100,110 40,190 65,190" fill="#3a8660"/>
                <polygon points="100,110 160,190 135,190" fill="#4a9670"/>
                <rect x="85" y="190" width="30" height="50" fill="#3a8660"/>
                <rect x="100" y="190" width="15" height="50" fill="#4a9670"/>
                <circle cx="100" cy="120" r="22" fill="#f5f5dc"/>
                <path d="M 90,130 L 90,160 L 110,160 L 110,130 L 105,130 L 105,145 L 95,145 L 95,130 Z" fill="#f5f5dc"/>
            </svg>
            <h2 class="sidebar-title">PineLock</h2>
            <p class="sidebar-subtitle">System zarzÄ…dzania</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/dashboard" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                Panel gÅ‚Ã³wny
            </a>
            <a href="/locks" class="nav-item active">
                <span class="nav-icon">ğŸ”</span>
                Domki
            </a>
            <a href="/access-codes" class="nav-item">
                <span class="nav-icon">ğŸ”¢</span>
                Kody PIN
            </a>
            <a href="/rfid-cards" class="nav-item">
                <span class="nav-icon">ğŸ“‡</span>
                Karty RFID
            </a>
            <a href="/access-logs" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                Historia dostÄ™pu
            </a>
            <a href="/settings" class="nav-item">
                <span class="nav-icon">âš™ï¸</span>
                Ustawienia
            </a>
            <a href="/logout" class="nav-item" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <span class="nav-icon">ğŸšª</span>
                Wyloguj siÄ™
            </a>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <div class="header">
            <div>
                <a href="/locks" style="color: var(--pine-green); text-decoration: none; font-size: 14px; display: inline-block; margin-bottom: 10px;">
                    â† PowrÃ³t do listy
                </a>
                <h1 class="header-title">ğŸ” {{ lock.name }}</h1>
            </div>
            <div class="header-actions">
                {% if lock.is_online %}
                    {% if lock.is_locked %}
                    <button class="btn btn-success" onclick="toggleLock('unlock')">
                        ğŸ”“ OtwÃ³rz domek
                    </button>
                    {% else %}
                    <button class="btn btn-danger" onclick="toggleLock('lock')">
                        ğŸ”’ Zamknij domek
                    </button>
                    {% endif %}
                {% else %}
                <button class="btn" style="background: #ccc; cursor: not-allowed;" disabled>
                    âš ï¸ UrzÄ…dzenie offline
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Lock Status Card -->
        <div class="form-card">
            <h2 class="form-title">Status urzÄ…dzenia</h2>
            
            <div class="stats-grid" style="margin-bottom: 0;">
                <div class="stat-card" style="box-shadow: none; border: 1px solid var(--light-gray);">
                    <div class="stat-icon {{ 'green' if lock.is_locked else 'yellow' }}">
                        {{ 'ğŸ”’' if lock.is_locked else 'ğŸ”“' }}
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Status zamka</div>
                        <div class="stat-value" style="font-size: 24px;">
                            {{ 'ZamkniÄ™ty' if lock.is_locked else 'Otwarty' }}
                        </div>
                    </div>
                </div>
                
                <div class="stat-card" style="box-shadow: none; border: 1px solid var(--light-gray);">
                    <div class="stat-icon {{ 'green' if lock.is_online else 'red' }}">
                        {{ 'ğŸ“¡' if lock.is_online else 'âš ï¸' }}
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">PoÅ‚Ä…czenie</div>
                        <div class="stat-value" style="font-size: 24px;">
                            {{ 'Online' if lock.is_online else 'Offline' }}
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                <p><strong>ğŸ“ Lokalizacja:</strong> {{ lock.location }}</p>
                <p><strong>ğŸ†” Device ID:</strong> <code>{{ lock.device_id }}</code></p>
                <p><strong>ğŸ“ Opis:</strong> {{ lock.description or 'Brak opisu' }}</p>
                {% if lock.last_seen %}
                <p><strong>â° Ostatnio widziany:</strong> {{ lock.last_seen }}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Access Methods -->
        <div class="form-card" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="form-title" style="margin-bottom: 0;">ğŸ”‘ Metody dostÄ™pu</h2>
                <button class="btn btn-secondary btn-sm" onclick="showAddAccessModal()">
                    â• Dodaj dostÄ™p
                </button>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Typ</th>
                            <th>Identyfikator</th>
                            <th>Opis</th>
                            <th>WaÅ¼ny od</th>
                            <th>WaÅ¼ny do</th>
                            <th>Status</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for access in access_methods %}
                        <tr>
                            <td>{{ 'ğŸ”¢ PIN' if access.type == 'pin' else 'ğŸ“‡ RFID' }}</td>
                            <td><code>{{ access.identifier }}</code></td>
                            <td>{{ access.description }}</td>
                            <td>{{ access.valid_from }}</td>
                            <td>{{ access.valid_to or 'Bezterminowy' }}</td>
                            <td>
                                {% if access.is_active %}
                                <span class="text-success">âœ… Aktywny</span>
                                {% else %}
                                <span class="text-error">âŒ Nieaktywny</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteAccess('{{ access.id }}')">
                                    ğŸ—‘ï¸
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% if not access_methods %}
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: var(--dark-gray);">
                                Brak zdefiniowanych metod dostÄ™pu
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Access History -->
        <div class="form-card" style="margin-top: 30px;">
            <h2 class="form-title">ğŸ“Š Historia dostÄ™pu</h2>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Czas</th>
                            <th>Typ dostÄ™pu</th>
                            <th>Akcja</th>
                            <th>Status</th>
                            <th>SzczegÃ³Å‚y</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in access_history %}
                        <tr>
                            <td>{{ log.timestamp }}</td>
                            <td>{{ 'ğŸ”¢ PIN' if log.access_type == 'pin' else 'ğŸ“‡ RFID' if log.access_type == 'rfid' else 'ğŸŒ Remote' }}</td>
                            <td>{{ log.action }}</td>
                            <td>
                                {% if log.success %}
                                <span class="text-success">âœ… Sukces</span>
                                {% else %}
                                <span class="text-error">âŒ Odmowa</span>
                                {% endif %}
                            </td>
                            <td>{{ log.details or '-' }}</td>
                        </tr>
                        {% endfor %}
                        
                        {% if not access_history %}
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--dark-gray);">
                                Brak historii dostÄ™pu
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Danger Zone -->
        <div class="form-card" style="margin-top: 30px; border: 2px solid var(--error);">
            <h2 class="form-title" style="color: var(--error);">âš ï¸ Strefa zagroÅ¼enia</h2>
            <p style="margin-bottom: 20px; color: var(--dark-gray);">
                Uwaga: PoniÅ¼sze akcje sÄ… nieodwracalne
            </p>
            <button class="btn btn-danger" onclick="deleteLock()">
                ğŸ—‘ï¸ UsuÅ„ domek
            </button>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function toggleLock(action) {
        if (!confirm(`Czy na pewno chcesz ${action === 'lock' ? 'zamknÄ…Ä‡' : 'otworzyÄ‡'} ten domek?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/locks/{{ lock.id }}/command`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command: action })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('âœ… Komenda wysÅ‚ana pomyÅ›lnie');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                alert('âŒ BÅ‚Ä…d: ' + (data.detail || 'Nie udaÅ‚o siÄ™ wykonaÄ‡ operacji'));
            }
        } catch (error) {
            alert('âŒ BÅ‚Ä…d poÅ‚Ä…czenia: ' + error.message);
        }
    }
    
    function showAddAccessModal() {
        // TODO: Implement modal for adding access methods
        alert('Funkcja w przygotowaniu - uÅ¼yj API do dodania metod dostÄ™pu');
    }
    
    async function deleteAccess(accessId) {
        if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ metodÄ™ dostÄ™pu?')) {
            return;
        }
        
        // TODO: Implement access method deletion
        alert('Funkcja w przygotowaniu');
    }
    
    async function deleteLock() {
        if (!confirm('âš ï¸ CZY NA PEWNO chcesz usunÄ…Ä‡ ten domek?\n\nSpowoduje to rÃ³wnieÅ¼ usuniÄ™cie wszystkich metod dostÄ™pu i historii. Ta operacja jest NIEODWRACALNA!')) {
            return;
        }
        
        if (!confirm('Ostatnia szansa - czy naprawdÄ™ chcesz usunÄ…Ä‡ domek "{{ lock.name }}"?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/locks/{{ lock.id }}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('âœ… Domek zostaÅ‚ usuniÄ™ty');
                window.location.href = '/dashboard';
            } else {
                const data = await response.json();
                alert('âŒ BÅ‚Ä…d: ' + (data.detail || 'Nie udaÅ‚o siÄ™ usunÄ…Ä‡ domku'));
            }
        } catch (error) {
            alert('âŒ BÅ‚Ä…d poÅ‚Ä…czenia: ' + error.message);
        }
    }
</script>
{% endblock %}
