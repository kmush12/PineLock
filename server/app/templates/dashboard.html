{% extends "base.html" %}

{% block title %}Domki - PineLock{% endblock %}

{% block content %}
<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- Mobile Header -->
<div class="mobile-header">
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <span>‚ò∞</span>
        <span class="mobile-title">PineLock</span>
    </button>
    <div class="user-info">
        <div class="user-avatar">{{ user_initial }}</div>
    </div>
</div>

<div class="dashboard-container">
    {% if message %}
    <div class="alert alert-success"
        style="margin-bottom: 20px; padding: 15px; background: var(--success-bg); color: var(--success-text); border: 1px solid var(--success-border); border-radius: 8px;">
        {{ message }}
    </div>
    {% endif %}

    <!-- Desktop Top Navbar -->
    {% include "desktop_navbar.html" %}

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Sidebar -->
        {% include "sidebar.html" %}

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <h1 class="header-title" style="display: flex; align-items: center;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Domki
                </h1>
                <div class="header-actions">
                    <div class="user-info">
                        <div class="user-avatar">{{ user_initial }}</div>
                        <span>{{ username }}</span>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card" onclick="showLocksModal('all')" style="cursor: pointer;">
                    <div class="stat-icon green">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Wszystkie</div>
                        <div class="stat-value">{{ total_locks }}</div>
                    </div>
                </div>

                <div class="stat-card" onclick="showLocksModal('locked')" style="cursor: pointer;">
                    <div class="stat-icon yellow">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Zajƒôte</div>
                        <div class="stat-value">{{ locked_count }}</div>
                    </div>
                </div>

                <div class="stat-card" onclick="showLocksModal('unlocked')" style="cursor: pointer;">
                    <div class="stat-icon green">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Wolne</div>
                        <div class="stat-value">{{ unlocked_count }}</div>
                    </div>
                </div>

                <div class="stat-card" onclick="showLocksModal('offline')" style="cursor: pointer;">
                    <div class="stat-icon red">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                            <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path>
                            <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path>
                            <path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path>
                            <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path>
                            <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                            <line x1="12" y1="20" x2="12.01" y2="20"></line>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Offline</div>
                        <div class="stat-value">{{ offline_count }}</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="margin-bottom: 20px; display: flex; gap: 15px;">
                <a href="/ui/locks/new" class="btn btn-primary"
                    style="width: auto; display: flex; align-items: center; gap: 8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Dodaj nowy domek
                </a>
                <button class="btn btn-secondary" onclick="refreshLocks()">
                    üîÑ Od≈õwie≈º status
                </button>
            </div>

            <!-- Locks Grid -->
            <div class="locks-grid">
                {% for lock in locks %}
                <div class="lock-card">
                    <div class="lock-card-header">
                        <img src="{{ url_for('static', path='/home.svg') }}" alt="Dom" class="lock-icon-img">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <!-- Lock Status Icon -->
                            <div class="status-icon-container {{ 'status-free' if lock.is_key_present else 'status-occupied' }}"
                                title="{{ 'Wolny' if lock.is_key_present else 'Zajƒôty' }}">
                                {% if lock.is_key_present %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                                </svg>
                                {% else %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                                {% endif %}
                            </div>
                            <!-- Online/Offline Icon -->
                            <div class="status-icon-container {{ 'status-online' if lock.is_online else 'status-offline' }}"
                                title="{{ 'Online' if lock.is_online else 'Offline' }}">
                                {% if lock.is_online %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                                    <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                                    <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                                    <line x1="12" y1="20" x2="12.01" y2="20"></line>
                                </svg>
                                {% else %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="1" y1="1" x2="23" y2="23"></line>
                                    <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path>
                                    <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path>
                                    <path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path>
                                    <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path>
                                    <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                                    <line x1="12" y1="20" x2="12.01" y2="20"></line>
                                </svg>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="lock-card-body">
                        <h3 class="lock-name">{{ lock.name }}</h3>
                        <p class="lock-location">üìç {{ lock.location }}</p>
                        <p class="lock-id">ID: {{ lock.device_id }}</p>

                        <!-- Key Presence Indicator -->
                        <div class="key-status"
                            style="margin-top: 12px; display: flex; align-items: center; gap: 8px; font-size: 0.9em;">
                            {% if lock.is_key_present %}
                            <span
                                style="color: var(--success-text); display: flex; align-items: center; gap: 4px; background: var(--success-bg); padding: 4px 8px; border-radius: 4px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path
                                        d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4">
                                    </path>
                                </svg>
                                Klucz w skrytce
                            </span>
                            {% else %}
                            <span
                                style="color: var(--warning-text); display: flex; align-items: center; gap: 4px; background: var(--warning-bg); padding: 4px 8px; border-radius: 4px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path
                                        d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4">
                                    </path>
                                    <line x1="3" y1="3" x2="21" y2="21"></line>
                                </svg>
                                Brak klucza
                            </span>
                            {% endif %}
                        </div>

                        {% if lock.last_seen %}
                        <p class="lock-id" style="margin-top: 8px;">
                            ‚è∞ Ostatnio widziany: {{ lock.last_seen }}
                        </p>
                        {% endif %}
                    </div>

                    <div class="lock-card-footer">
                        <a href="/ui/locks/{{ lock.id }}" class="btn btn-secondary btn-sm">
                            üëÅÔ∏è Szczeg√≥≈Çy
                        </a>
                        {% if lock.is_online %}
                        {% if lock.is_locked %}
                        <button class="btn btn-success btn-sm" onclick="toggleLock('{{ lock.id }}', 'unlock')">
                            üîì Otw√≥rz
                        </button>
                        {% else %}
                        <button class="btn btn-danger btn-sm" onclick="toggleLock('{{ lock.id }}', 'lock')">
                            üîí Zamknij
                        </button>
                        {% endif %}
                        {% else %}
                        <button class="btn btn-sm" style="background: #ccc; cursor: not-allowed;" disabled>
                            ‚ö†Ô∏è Offline
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if not locks %}
            <div
                style="text-align: center; padding: 60px 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(30, 89, 69, 0.15);">
                <div style="font-size: 64px; margin-bottom: 20px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
                        stroke-linecap="round" stroke-linejoin="round" style="color: var(--forest-green);">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </div>
                <h2 style="color: var(--forest-green); margin-bottom: 10px;">Brak domk√≥w</h2>
                <p style="color: var(--dark-gray); margin-bottom: 30px;">Dodaj pierwszy domek, aby rozpoczƒÖƒá zarzƒÖdzanie
                </p>
                <a href="/ui/locks/new" class="btn btn-primary" style="width: auto;">
                    ‚ûï Dodaj domek
                </a>
            </div>
            {% endif %}

            <!-- Logs Section -->
            <div style="margin-top: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--forest-green); font-size: 24px; margin: 0;">
                        üìä Ostatnie zdarzenia
                    </h2>
                </div>

                <!-- Access Logs Tab -->
                <div id="access-logs-content" class="log-content">

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Czas</th>
                                    <th>Domek</th>
                                    <th>Typ dostƒôpu</th>
                                    <th>Akcja</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in recent_logs %}
                                <tr>
                                    <td>{{ log.timestamp }}</td>
                                    <td>{{ log.lock_name }}</td>
                                    <td>
                                        {% if log.access_type == 'pin' %}
                                        <span
                                            style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; background: #e8f5e9; color: #2e7d32; font-size: 12px; font-weight: 500;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                            </svg>
                                            PIN
                                        </span>
                                        {% elif log.access_type == 'rfid' %}
                                        <span
                                            style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; background: #e3f2fd; color: #1565c0; font-size: 12px; font-weight: 500;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                                <line x1="1" y1="10" x2="23" y2="10"></line>
                                            </svg>
                                            RFID
                                        </span>
                                        {% else %}
                                        <span
                                            style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; background: #f3e5f5; color: #7b1fa2; font-size: 12px; font-weight: 500;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <path
                                                    d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
                                                </path>
                                            </svg>
                                            Remote
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ log.action }}</td>
                                    <td>
                                        {% if log.success %}
                                        <span
                                            style="display: inline-flex; align-items: center; gap: 4px; color: #2e7d32; font-weight: 500;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                            Sukces
                                        </span>
                                        {% else %}
                                        <span
                                            style="display: inline-flex; align-items: center; gap: 4px; color: #c62828; font-weight: 500;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                                <line x1="9" y1="9" x2="15" y2="15"></line>
                                            </svg>
                                            Odmowa
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}

                                {% if not recent_logs %}
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: var(--dark-gray);">
                                        Brak ostatnich zdarze≈Ñ
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
        </main>

    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: var(--forest-green); font-weight: 600;">
                Wysy≈Çanie komendy...
            </p>
        </div>
    </div>

    <!-- Locks Modal -->
    <div id="locksModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header"
                style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--light-gray); margin-bottom: 20px;">
                <h2 id="modalTitle" style="margin: 0; color: var(--forest-green);">Domki</h2>
                <button onclick="closeLocksModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--dark-gray); padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Locks will be populated here -->
            </div>


        </div>
    </div>
    {% endblock %}

    {% block scripts %}
    <script>
        const locks = {{ locks| tojson }};

        function showLocksModal(type) {
            const modal = document.getElementById('locksModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            let filteredLocks = [];
            let title = '';

            switch (type) {
                case 'all':
                    filteredLocks = locks;
                    title = 'Wszystkie';
                    break;
                case 'locked':
                    filteredLocks = locks.filter(lock => lock.is_locked);
                    title = 'Zajƒôte domki';
                    break;
                case 'unlocked':
                    filteredLocks = locks.filter(lock => !lock.is_locked && lock.is_online);
                    title = 'Wolne domki';
                    break;
                case 'offline':
                    filteredLocks = locks.filter(lock => !lock.is_online);
                    title = 'Offline domki';
                    break;
            }

            modalTitle.textContent = title;

            if (filteredLocks.length === 0) {
                modalBody.innerHTML = '<p style="text-align: center; color: var(--dark-gray); padding: 40px;">Brak domk√≥w w tej kategorii</p>';
            } else {
                let html = '<div class="locks-grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';
                filteredLocks.forEach(lock => {
                    const statusText = !lock.is_key_present ? 'Zajƒôty' : (lock.is_online ? 'Wolny' : 'Offline');
                    const statusClass = !lock.is_key_present ? 'status-occupied' : (lock.is_online ? 'status-free' : 'status-offline');
                    html += `
                    <div class="lock-card">
                        <div class="lock-card-header">
                            <img src="/static/home.svg" alt="Dom" class="lock-icon-img">
                            <span class="lock-status-badge ${statusClass}">
                                ${statusText}
                            </span>
                        </div>

                        <div class="lock-card-body">
                            <h3 class="lock-name">${lock.name}</h3>
                            <p class="lock-location">üìç ${lock.location}</p>
                            <p class="lock-id">ID: ${lock.device_id}</p>
                            
                            <div class="key-status" style="margin-top: 12px; display: flex; align-items: center; gap: 8px; font-size: 0.9em;">
                                ${lock.is_key_present ?
                            `<span style="color: var(--success-text); display: flex; align-items: center; gap: 4px; background: var(--success-bg); padding: 4px 8px; border-radius: 4px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                                    </svg>
                                    Klucz w skrytce
                                </span>` :
                            `<span style="color: var(--warning-text); display: flex; align-items: center; gap: 4px; background: var(--warning-bg); padding: 4px 8px; border-radius: 4px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                                        <line x1="3" y1="3" x2="21" y2="21"></line>
                                    </svg>
                                    Brak klucza
                                </span>`
                        }
                            </div>

                            ${lock.last_seen ? `<p class="lock-id" style="margin-top: 8px;">‚è∞ Ostatnio widziany: ${lock.last_seen}</p>` : ''}
                        </div>

                        <div class="lock-card-footer">
                            <a href="/ui/locks/${lock.id}" class="btn btn-secondary btn-sm">
                                üëÅÔ∏è Szczeg√≥≈Çy
                            </a>
                            ${lock.is_online ? (lock.is_locked ?
                            `<button class="btn btn-success btn-sm" onclick="closeLocksModal(); toggleLock('${lock.id}', 'unlock')">
                                    üîì Otw√≥rz
                                </button>` :
                            `<button class="btn btn-danger btn-sm" onclick="closeLocksModal(); toggleLock('${lock.id}', 'lock')">
                                    üîí Zamknij
                                </button>`) :
                            '<button class="btn btn-sm" style="background: #ccc; cursor: not-allowed;" disabled>‚ö†Ô∏è Offline</button>'}
                        </div>
                    </div>
                `;
                });
                html += '</div>';
                modalBody.innerHTML = html;
            }

            modal.classList.add('active');
        }

        function closeLocksModal() {
            document.getElementById('locksModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('locksModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeLocksModal();
            }
        });

        async function toggleLock(lockId, action) {
            const modal = document.getElementById('loadingModal');
            modal.classList.add('active');

            try {
                const response = await fetch(`/api/v1/locks/${lockId}/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: action })
                });

                const data = await response.json();

                if (response.ok) {
                    modal.classList.remove('active');

                    // Get lock name
                    const lock = locks.find(l => l.id == lockId);
                    const lockName = lock ? lock.name : 'Domek';
                    const actionText = action === 'unlock' ? 'otworzony' : 'zamkniƒôty';

                    // Show toast notification
                    showToast(`${lockName} zosta≈Ç ${actionText}`);
                } else {
                    alert('‚ùå B≈ÇƒÖd: ' + (data.detail || 'Nie uda≈Ço siƒô wykonaƒá operacji'));
                    modal.classList.remove('active');
                }
            } catch (error) {
                alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message);
                modal.classList.remove('active');
            }
        }

        function showToast(message) {
            // Remove existing toast if any
            const existingToast = document.getElementById('toast');
            if (existingToast) {
                existingToast.remove();
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--forest-green);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                cursor: pointer;
                animation: slideIn 0.3s ease-out;
            `;

            document.body.appendChild(toast);

            // Remove on click
            toast.addEventListener('click', () => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            });

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 3000);
        }


        async function refreshLocks() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Od≈õwie≈ºanie...';

            try {
                // Request status update from all locks
                const response = await fetch('/api/v1/locks');
                if (response.ok) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            } catch (error) {
                console.error('Refresh error:', error);
                btn.disabled = false;
                btn.textContent = 'üîÑ Od≈õwie≈º status';
            }
        }

        // Real-time updates via Server-Sent Events (SSE)
        let eventSource = null;

        function connectSSE() {
            eventSource = new EventSource('/api/v1/events');

            eventSource.onmessage = function (event) {
                try {
                    const message = JSON.parse(event.data);

                    if (message.type === 'status_update') {
                        updateLockStatus(message.data);
                    }
                } catch (error) {
                    console.error('SSE parse error:', error);
                }
            };

            eventSource.onerror = function (error) {
                console.error('SSE connection error:', error);
                eventSource.close();

                // Reconnect after 5 seconds
                setTimeout(connectSSE, 5000);
            };

            console.log('SSE connected - real-time updates enabled');
        }

        function updateLockStatus(data) {
            // Find the lock card by lock_id
            const lockCards = document.querySelectorAll('.lock-card');

            lockCards.forEach(card => {
                const lockIdMatch = card.querySelector('a[href*="/ui/locks/"]');
                if (!lockIdMatch) return;

                const lockId = lockIdMatch.href.split('/').pop();

                if (parseInt(lockId) === data.lock_id) {
                    // Update lock icon (SVG)
                    const lockIconContainer = card.querySelector('.status-icon-container.status-free, .status-icon-container.status-occupied');
                    if (lockIconContainer) {
                        if (data.is_key_present) {
                            // Unlocked
                            lockIconContainer.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                            </svg>`;
                            lockIconContainer.className = 'status-icon-container status-free';
                            lockIconContainer.title = 'Wolny';
                        } else {
                            // Locked
                            lockIconContainer.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>`;
                            lockIconContainer.className = 'status-icon-container status-occupied';
                            lockIconContainer.title = 'Zajƒôty';
                        }
                    }

                    // Update online/offline icon (SVG)
                    const onlineIconContainer = card.querySelector('.status-icon-container.status-online, .status-icon-container.status-offline');
                    if (onlineIconContainer) {
                        if (data.is_online) {
                            // Online - WiFi icon
                            onlineIconContainer.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                                <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                                <line x1="12" y1="20" x2="12.01" y2="20"></line>
                            </svg>`;
                            onlineIconContainer.className = 'status-icon-container status-online';
                            onlineIconContainer.title = 'Online';
                        } else {
                            // Offline - WiFi off icon
                            onlineIconContainer.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="1" y1="1" x2="23" y2="23"></line>
                                <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path>
                                <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path>
                                <path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path>
                                <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path>
                                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                                <line x1="12" y1="20" x2="12.01" y2="20"></line>
                            </svg>`;
                            onlineIconContainer.className = 'status-icon-container status-offline';
                            onlineIconContainer.title = 'Offline';
                        }
                    }

                    // Update key presence indicator
                    const keyStatusContainer = card.querySelector('.key-status');
                    if (keyStatusContainer && data.is_key_present !== undefined) {
                        if (data.is_key_present) {
                            keyStatusContainer.innerHTML = `<span style="color: var(--success-text); display: flex; align-items: center; gap: 4px; background: var(--success-bg); padding: 4px 8px; border-radius: 4px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                                    </svg>
                                    Klucz w skrytce
                                </span>`;
                        } else {
                            keyStatusContainer.innerHTML = `<span style="color: var(--warning-text); display: flex; align-items: center; gap: 4px; background: var(--warning-bg); padding: 4px 8px; border-radius: 4px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                                        <line x1="3" y1="3" x2="21" y2="21"></line>
                                    </svg>
                                    Brak klucza
                                </span>`;
                        }
                    }

                    console.log(`‚úÖ Updated lock ${data.lock_id}: online=${data.is_online}, key=${data.is_key_present}`);
                }
            });
        }

        // Connect to SSE on page load
        connectSSE();

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });


    </script>
    </main>
</div>
</div>
{% endblock %}