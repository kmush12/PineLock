{% extends "base.html" %}
{% block content %}
{% if pending_devices %}
<section class="card pending-banner">
    <div class="pending-header">
        <div>
            <p class="eyebrow">Nowe domki wykryte automatycznie</p>
            <h2>{{ pending_devices|length }} do skonfigurowania</h2>
            <p>Urządzenie zgłosiło się po raz pierwszy. Przypisz nazwę i lokalizację, aby w pełni je aktywować.</p>
        </div>
        <div class="pending-actions">
            <a href="/ui/locks/new" class="btn ghost">Dodaj ręcznie</a>
        </div>
    </div>
    <div class="pending-list">
        {% for pending in pending_devices %}
        <div class="pending-chip">
            <div>
                <strong>{{ pending.device_id }}</strong>
                <span>Ostatni sygnał: {{ pending.last_seen.strftime("%Y-%m-%d %H:%M") }}</span>
            </div>
            <a href="/ui/locks/new?device_id={{ pending.device_id }}" class="btn primary small">Skonfiguruj</a>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}
<section class="card domki-panel">
    <div class="card-header">
        <div>
            <p class="eyebrow">Twoja flota</p>
            <h1>Domki</h1>
            <p>Zdalnie zarządzaj dostępem i szybko zmieniaj PIN-y mieszkańców.</p>
        </div>
        <div class="actions stacked">
            <form method="get" action="/ui/dashboard">
                <button type="submit" class="btn">Odśwież</button>
            </form>
            <a href="/ui/locks/new" class="btn primary">+ Dodaj domek</a>
        </div>
    </div>
    {% if message %}
        {% set success_map = {
            "code_created": "PIN został dodany.",
            "lock_created": "Domek został dodany.",
            "pin_created": "Nowy PIN zapisany i wysłany do domku.",
            "pin_updated": "PIN został zaktualizowany."
        } %}
        <div class="alert alert-success">{{ success_map.get(message, "Operacja wykonana pomyślnie.") }}</div>
    {% endif %}
    {% if error %}
        {% set error_map = {
            "invalid_pin": "PIN powinien zawierać 4-10 cyfr.",
            "not_found": "Wybrany domek nie istnieje."
        } %}
        <div class="alert alert-error">{{ error_map.get(error, error) }}</div>
    {% endif %}
    {% if locks %}
    <div class="domki-grid">
        {% for lock in locks %}
        <article class="domek-card {% if lock.is_online %}online{% else %}offline{% endif %}">
            <div class="domek-card-header">
                <div>
                    <p class="eyebrow">Domek</p>
                    <h2>{{ lock.name }}</h2>
                    <p class="muted">{{ lock.location or "Brak lokalizacji" }}</p>
                </div>
                {% if lock.is_online %}
                <span class="status online pill">Online</span>
                {% else %}
                <span class="status offline pill">Offline</span>
                {% endif %}
            </div>
            <div class="domek-card-body">
                <div class="meta">
                    <span class="label">Device ID</span>
                    <strong>{{ lock.device_id }}</strong>
                </div>
                <div class="meta">
                    <span class="label">Ostatni kontakt</span>
                    {% if lock.last_seen %}
                    <strong>{{ lock.last_seen.strftime("%Y-%m-%d %H:%M") }}</strong>
                    {% else %}
                    <strong>Brak danych</strong>
                    {% endif %}
                </div>
                <div class="meta">
                    <span class="label">Klucz</span>
                    {% if lock.is_key_present %}
                    <span class="status online pill mini">Jest</span>
                    {% else %}
                    <span class="status warning pill mini">Brak</span>
                    {% endif %}
                </div>
            </div>
            <div class="pin-quick">
                <div>
                    <h3>Szybka zmiana PIN-u</h3>
                    <p>Akcja nadpisze lub utworzy PIN o wskazanej nazwie (domyślnie „PIN główny”).</p>
                </div>
                <form method="post" action="/ui/locks/{{ lock.id }}/quick-pin" class="pin-form">
                    <div class="pin-inputs">
                        <input type="text" name="code" placeholder="Nowy PIN" minlength="4" maxlength="10" pattern="\\d+" required>
                        <input type="text" name="name" placeholder="Etykieta (opcjonalna)">
                    </div>
                    <button type="submit" class="btn primary">Zapisz PIN</button>
                </form>
            </div>
            <div class="domek-actions">
                <a href="/ui/locks/{{ lock.id }}" class="btn ghost">Szczegóły</a>
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="muted center">Brak zarejestrowanych domków.</p>
    {% endif %}
</section>
{% endblock %}
