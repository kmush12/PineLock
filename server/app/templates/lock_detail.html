{% extends "base.html" %}

{% block title %}{{ lock.name }} - PineLock{% endblock %}

{% block content %}
<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- Mobile Header -->
<div class="mobile-header">
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <span>‚ò∞</span>
        <span class="mobile-title">{{ lock.name }}</span>
    </button>
</div>

<div class="dashboard-container">
    <!-- Desktop Top Navbar -->
    {% include "desktop_navbar.html" %}

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Sidebar (same as dashboard) -->
        {% include "sidebar.html" %}

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <div>
                    <a href="/ui/locks"
                        style="color: var(--pine-green); text-decoration: none; font-size: 14px; display: inline-block; margin-bottom: 10px;">
                        ‚Üê Powr√≥t do listy
                    </a>
                    <h1 class="header-title"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                            viewBox="0 0 100 100" style="margin-right: 12px; vertical-align: bottom;">
                            <g fill="none" stroke="#155b3a" stroke-width="6" stroke-linejoin="round"
                                stroke-linecap="round">
                                <path d="M20 40 L50 15 L80 40 V85 H20 Z"></path>
                                <rect x="40" y="50" width="20" height="35"></rect>
                            </g>
                        </svg><span style="position: relative; top: 4px;"> {{ lock.name }}</span></h1>
                </div>
                <div class="header-actions">
                    {% if lock.is_online %}
                    {% if lock.is_locked %}
                    <button class="btn btn-success" onclick="toggleLock('unlock')">
                        üîì Otw√≥rz domek
                    </button>
                    {% else %}
                    <button class="btn btn-danger" onclick="toggleLock('lock')">
                        üîí Zamknij domek
                    </button>
                    {% endif %}
                    {% else %}
                    <button class="btn" style="background: #ccc; cursor: not-allowed;" disabled>
                        ‚ö†Ô∏è UrzƒÖdzenie offline
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Lock Status Card -->
            <div class="form-card">
                <h2 class="form-title">Status urzƒÖdzenia</h2>

                <div class="stats-grid" style="margin-bottom: 0;">
                    <div class="stat-card" style="box-shadow: none; border: 1px solid var(--light-gray);">
                        <div class="stat-icon {{ 'green' if lock.is_locked else 'yellow' }}">
                            {{ 'üîí' if lock.is_locked else 'üîì' }}
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">Status domku</div>
                            <div class="stat-value" style="font-size: 24px;">
                                {{ 'Zajƒôty' if lock.is_locked else 'Wolny' }}
                            </div>
                        </div>
                    </div>

                    <div class="stat-card" style="box-shadow: none; border: 1px solid var(--light-gray);">
                        <div class="stat-icon {{ 'green' if lock.is_online else 'red' }}">
                            {{ 'üåê' if lock.is_online else '‚ö†Ô∏è' }}
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">Po≈ÇƒÖczenie</div>
                            <div class="stat-value" style="font-size: 24px;">
                                {{ 'Online' if lock.is_online else 'Offline' }}
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                    <p><strong>üìç Lokalizacja:</strong> {{ lock.location }}</p>
                    <p><strong>üÜî Device ID:</strong> <code>{{ lock.device_id }}</code></p>
                    <p><strong>üìù Opis:</strong> {{ lock.description or 'Brak opisu' }}</p>
                    {% if lock.last_seen %}
                    <p><strong>‚è∞ Ostatnio widziany:</strong> {{ lock.last_seen }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Access Methods -->
            <div class="form-card" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="form-title" style="margin-bottom: 0;">üîë Metody dostƒôpu</h2>
                    <button class="btn btn-secondary btn-sm" onclick="showAddAccessModal()">
                        ‚ûï Dodaj dostƒôp
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Typ</th>
                                <th>Identyfikator</th>
                                <th>Opis</th>
                                <th>Wa≈ºny od</th>
                                <th>Wa≈ºny do</th>
                                <th>Status</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for access in access_methods %}
                            <tr>
                                <td>{{ 'üî¢ PIN' if access.type == 'pin' else 'üìá RFID' }}</td>
                                <td><code>{{ access.identifier }}</code></td>
                                <td>{{ access.description }}</td>
                                <td>{{ access.valid_from }}</td>
                                <td>{{ access.valid_to or 'Bezterminowy' }}</td>
                                <td>
                                    {% if access.is_active %}
                                    <span class="text-success">‚úÖ Aktywny</span>
                                    {% else %}
                                    <span class="text-error">‚ùå Nieaktywny</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="deleteAccess('{{ access.id }}')">
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}

                            {% if not access_methods %}
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: var(--dark-gray);">
                                    Brak zdefiniowanych metod dostƒôpu
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Access History -->
            <div class="form-card" style="margin-top: 30px;">
                <h2 class="form-title">üìä Historia dostƒôpu</h2>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Czas</th>
                                <th>Typ dostƒôpu</th>
                                <th>Akcja</th>
                                <th>Status</th>
                                <th>Szczeg√≥≈Çy</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in access_history %}
                            <tr>
                                <td>{{ log.timestamp }}</td>
                                <td>{{ 'üî¢ PIN' if log.access_type == 'pin' else 'üìá RFID' if log.access_type == 'rfid'
                                    else 'üåê Remote' }}</td>
                                <td>{{ log.action }}</td>
                                <td>
                                    {% if log.success %}
                                    <span class="text-success">‚úÖ Sukces</span>
                                    {% else %}
                                    <span class="text-error">‚ùå Odmowa</span>
                                    {% endif %}
                                </td>
                                <td>{{ log.details or '-' }}</td>
                            </tr>
                            {% endfor %}

                            {% if not access_history %}
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: var(--dark-gray);">
                                    Brak historii dostƒôpu
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="form-card" style="margin-top: 30px; border: 2px solid var(--error);">
                <h2 class="form-title" style="color: var(--error);">‚ö†Ô∏è Strefa zagro≈ºenia</h2>
                <p style="margin-bottom: 20px; color: var(--dark-gray);">
                    Uwaga: Poni≈ºsze akcje sƒÖ nieodwracalne
                </p>
                <button class="btn btn-danger" onclick="deleteLock()">
                    üóëÔ∏è Usu≈Ñ domek
                </button>
            </div>
        </main>
    </div>
    {% endblock %}

    {% block scripts %}
    <script>
        async function toggleLock(action) {
            if (!confirm(`Czy na pewno chcesz ${action === 'lock' ? 'zamknƒÖƒá' : 'otworzyƒá'} ten domek?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/locks/{{ lock.id }}/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: action })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ Komenda wys≈Çana pomy≈õlnie');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('‚ùå B≈ÇƒÖd: ' + (data.detail || 'Nie uda≈Ço siƒô wykonaƒá operacji'));
                }
            } catch (error) {
                alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message);
            }
        }

        function showAddAccessModal() {
            // TODO: Implement modal for adding access methods
            alert('Funkcja w przygotowaniu - u≈ºyj API do dodania metod dostƒôpu');
        }

        async function deleteAccess(accessId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô metodƒô dostƒôpu?')) {
                return;
            }

            // TODO: Implement access method deletion
            alert('Funkcja w przygotowaniu');
        }

        async function deleteLock() {
            showDeleteModal();
        }

        async function performDelete() {
            try {
                const response = await fetch(`/api/v1/locks/{{ lock.id }}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    window.location.href = '/ui/locks?deleted=1';
                } else {
                    const data = await response.json();
                    alert('‚ùå B≈ÇƒÖd: ' + (data.detail || 'Nie uda≈Ço siƒô usunƒÖƒá domku'));
                }
            } catch (error) {
                alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message);
            }
        }

        function showDeleteModal() {
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            document.getElementById('deleteConfirmation').value = '';
        }

        async function confirmDelete() {
            const confirmation = document.getElementById('deleteConfirmation').value;
            if (confirmation !== 'TAK') {
                alert('‚ùå Musisz wpisaƒá dok≈Çadnie "TAK" aby usunƒÖƒá domek.');
                return;
            }
            closeDeleteModal();
            await performDelete();
        }
    </script>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" onclick="closeDeleteModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Potwierdzenie usuniƒôcia domku</h3>
                <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--error); font-weight: bold; margin-bottom: 15px;">
                    CZY NA PEWNO chcesz usunƒÖƒá ten domek?
                </p>
                <p style="margin-bottom: 15px;">
                    Spowoduje to r√≥wnie≈º usuniƒôcie wszystkich metod dostƒôpu i historii. Ta operacja jest
                    <strong>NIEODWRACALNA</strong>!
                </p>
                <p style="margin-bottom: 20px;">
                    Wpisz <strong>"TAK"</strong> w polu poni≈ºej aby potwierdziƒá:
                </p>
                <input type="text" id="deleteConfirmation" class="form-input" placeholder="Wpisz TAK"
                    style="text-align: center; font-weight: bold;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Anuluj</button>
                <button class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è Usu≈Ñ domek</button>
            </div>
        </div>
    </div>
    </main>
</div>
</div>
{% endblock %}