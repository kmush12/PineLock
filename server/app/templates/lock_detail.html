{% extends "base.html" %}

{% block title %}{{ lock.name }} - PineLock{% endblock %}

{% block content %}
<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- Mobile Header -->
<div class="mobile-header">
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <span>‚ò∞</span>
        <span class="mobile-title">{{ lock.name }}</span>
    </button>
</div>

<div class="dashboard-container">
    <!-- Desktop Top Navbar -->
    <nav class="desktop-navbar">
        <div class="desktop-navbar-brand">
            <img src="{{ url_for('static', path='/logo.png') }}" alt="PineLock" class="desktop-navbar-logo">
            <div>
                <h1 class="desktop-navbar-title">PineLock</h1>
                <p class="desktop-navbar-subtitle">System zarzƒÖdzania</p>
            </div>
        </div>
        
        <div class="desktop-navbar-nav">
            <a href="/ui/locks" class="desktop-nav-item {% if active_page == 'domki' %}active{% endif %}">
                <span class="desktop-nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </span>
                Domki
            </a>
            <a href="/ui/access-codes" class="desktop-nav-item {% if active_page == 'access-codes' %}active{% endif %}">
                <span class="desktop-nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                        <circle cx="12" cy="12" r="2"></circle>
                        <path d="M6 12h.01M18 12h.01"></path>
                    </svg>
                </span>
                Kody PIN
            </a>
            <a href="/ui/rfid-cards" class="desktop-nav-item {% if active_page == 'rfid-cards' %}active{% endif %}">
                <span class="desktop-nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                </span>
                Karty RFID
            </a>
            <a href="/ui/access-logs" class="desktop-nav-item {% if active_page == 'access-logs' %}active{% endif %}">
                <span class="desktop-nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                </span>
                Historia
            </a>
            <a href="/ui/settings" class="desktop-nav-item {% if active_page == 'settings' %}active{% endif %}">
                <span class="desktop-nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </span>
                Ustawienia
            </a>
        </div>
        
        <div class="desktop-navbar-user">
            <a href="/ui/logout" class="desktop-nav-item">
                <span class="desktop-nav-icon">üö™</span>
                Wyloguj
            </a>
        </div>
    </nav>
    
    <!-- Content Wrapper -->
    <div class="content-wrapper">
    <!-- Sidebar (same as dashboard) -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="{{ url_for('static', path='/logo.png') }}" alt="PineLock" class="sidebar-logo">
            <h2 class="sidebar-title">PineLock</h2>
            <p class="sidebar-subtitle">System zarzƒÖdzania</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/ui/locks" class="nav-item {% if active_page == 'domki' %}active{% endif %}">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </span>
                Domki
            </a>
            <a href="/ui/access-codes" class="nav-item {% if active_page == 'access-codes' %}active{% endif %}">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                        <circle cx="12" cy="12" r="2"></circle>
                        <path d="M6 12h.01M18 12h.01"></path>
                    </svg>
                </span>
                Kody PIN
            </a>
            <a href="/ui/rfid-cards" class="nav-item {% if active_page == 'rfid-cards' %}active{% endif %}">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                </span>
                Karty RFID
            </a>
            <a href="/ui/access-logs" class="nav-item {% if active_page == 'access-logs' %}active{% endif %}">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                </span>
                Historia dostƒôpu
            </a>
            <a href="/ui/settings" class="nav-item {% if active_page == 'settings' %}active{% endif %}">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </span>
                Ustawienia
            </a>
            <a href="/ui/logout" class="nav-item" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </span>
                Wyloguj siƒô
            </a>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <div class="header">
            <div>
                <a href="/ui/locks" style="color: var(--pine-green); text-decoration: none; font-size: 14px; display: inline-block; margin-bottom: 10px;">
                    ‚Üê Powr√≥t do listy
                </a>
                <h1 class="header-title">üîê {{ lock.name }}</h1>
            </div>
            <div class="header-actions">
                {% if lock.is_online %}
                    {% if lock.is_locked %}
                    <button class="btn btn-success" onclick="toggleLock('unlock')">
                        üîì Otw√≥rz domek
                    </button>
                    {% else %}
                    <button class="btn btn-danger" onclick="toggleLock('lock')">
                        üîí Zamknij domek
                    </button>
                    {% endif %}
                {% else %}
                <button class="btn" style="background: #ccc; cursor: not-allowed;" disabled>
                    ‚ö†Ô∏è UrzƒÖdzenie offline
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Lock Status Card -->
        <div class="form-card">
            <h2 class="form-title">Status urzƒÖdzenia</h2>
            
            <div class="stats-grid" style="margin-bottom: 0;">
                <div class="stat-card" style="box-shadow: none; border: 1px solid var(--light-gray);">
                    <div class="stat-icon {{ 'green' if lock.is_locked else 'yellow' }}">
                        {{ 'üîí' if lock.is_locked else 'üîì' }}
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Status zamka</div>
                        <div class="stat-value" style="font-size: 24px;">
                            {{ 'Zajƒôty' if lock.is_locked else 'Wolny' }}
                        </div>
                    </div>
                </div>
                
                <div class="stat-card" style="box-shadow: none; border: 1px solid var(--light-gray);">
                    <div class="stat-icon {{ 'green' if lock.is_online else 'red' }}">
                        {{ 'üì°' if lock.is_online else '‚ö†Ô∏è' }}
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Po≈ÇƒÖczenie</div>
                        <div class="stat-value" style="font-size: 24px;">
                            {{ 'Online' if lock.is_online else 'Offline' }}
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                <p><strong>üìç Lokalizacja:</strong> {{ lock.location }}</p>
                <p><strong>üÜî Device ID:</strong> <code>{{ lock.device_id }}</code></p>
                <p><strong>üìù Opis:</strong> {{ lock.description or 'Brak opisu' }}</p>
                {% if lock.last_seen %}
                <p><strong>‚è∞ Ostatnio widziany:</strong> {{ lock.last_seen }}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Access Methods -->
        <div class="form-card" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="form-title" style="margin-bottom: 0;">üîë Metody dostƒôpu</h2>
                <button class="btn btn-secondary btn-sm" onclick="showAddAccessModal()">
                    ‚ûï Dodaj dostƒôp
                </button>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Typ</th>
                            <th>Identyfikator</th>
                            <th>Opis</th>
                            <th>Wa≈ºny od</th>
                            <th>Wa≈ºny do</th>
                            <th>Status</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for access in access_methods %}
                        <tr>
                            <td>{{ 'üî¢ PIN' if access.type == 'pin' else 'üìá RFID' }}</td>
                            <td><code>{{ access.identifier }}</code></td>
                            <td>{{ access.description }}</td>
                            <td>{{ access.valid_from }}</td>
                            <td>{{ access.valid_to or 'Bezterminowy' }}</td>
                            <td>
                                {% if access.is_active %}
                                <span class="text-success">‚úÖ Aktywny</span>
                                {% else %}
                                <span class="text-error">‚ùå Nieaktywny</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteAccess('{{ access.id }}')">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% if not access_methods %}
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: var(--dark-gray);">
                                Brak zdefiniowanych metod dostƒôpu
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Access History -->
        <div class="form-card" style="margin-top: 30px;">
            <h2 class="form-title">üìä Historia dostƒôpu</h2>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Czas</th>
                            <th>Typ dostƒôpu</th>
                            <th>Akcja</th>
                            <th>Status</th>
                            <th>Szczeg√≥≈Çy</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in access_history %}
                        <tr>
                            <td>{{ log.timestamp }}</td>
                            <td>{{ 'üî¢ PIN' if log.access_type == 'pin' else 'üìá RFID' if log.access_type == 'rfid' else 'üåê Remote' }}</td>
                            <td>{{ log.action }}</td>
                            <td>
                                {% if log.success %}
                                <span class="text-success">‚úÖ Sukces</span>
                                {% else %}
                                <span class="text-error">‚ùå Odmowa</span>
                                {% endif %}
                            </td>
                            <td>{{ log.details or '-' }}</td>
                        </tr>
                        {% endfor %}
                        
                        {% if not access_history %}
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--dark-gray);">
                                Brak historii dostƒôpu
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Danger Zone -->
        <div class="form-card" style="margin-top: 30px; border: 2px solid var(--error);">
            <h2 class="form-title" style="color: var(--error);">‚ö†Ô∏è Strefa zagro≈ºenia</h2>
            <p style="margin-bottom: 20px; color: var(--dark-gray);">
                Uwaga: Poni≈ºsze akcje sƒÖ nieodwracalne
            </p>
            <button class="btn btn-danger" onclick="deleteLock()">
                üóëÔ∏è Usu≈Ñ domek
            </button>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function toggleLock(action) {
        if (!confirm(`Czy na pewno chcesz ${action === 'lock' ? 'zamknƒÖƒá' : 'otworzyƒá'} ten domek?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/locks/{{ lock.id }}/command`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command: action })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('‚úÖ Komenda wys≈Çana pomy≈õlnie');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                alert('‚ùå B≈ÇƒÖd: ' + (data.detail || 'Nie uda≈Ço siƒô wykonaƒá operacji'));
            }
        } catch (error) {
            alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message);
        }
    }
    
    function showAddAccessModal() {
        // TODO: Implement modal for adding access methods
        alert('Funkcja w przygotowaniu - u≈ºyj API do dodania metod dostƒôpu');
    }
    
    async function deleteAccess(accessId) {
        if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô metodƒô dostƒôpu?')) {
            return;
        }
        
        // TODO: Implement access method deletion
        alert('Funkcja w przygotowaniu');
    }
    
    async function deleteLock() {
        if (!confirm('‚ö†Ô∏è CZY NA PEWNO chcesz usunƒÖƒá ten domek?\n\nSpowoduje to r√≥wnie≈º usuniƒôcie wszystkich metod dostƒôpu i historii. Ta operacja jest NIEODWRACALNA!')) {
            return;
        }
        
        if (!confirm('Ostatnia szansa - czy naprawdƒô chcesz usunƒÖƒá domek "{{ lock.name }}"?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/locks/{{ lock.id }}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('‚úÖ Domek zosta≈Ç usuniƒôty');
                window.location.href = '/dashboard';
            } else {
                const data = await response.json();
                alert('‚ùå B≈ÇƒÖd: ' + (data.detail || 'Nie uda≈Ço siƒô usunƒÖƒá domku'));
            }
        } catch (error) {
            alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message);
        }
    }
</script>
    </main>
    </div>
</div>
{% endblock %}
